{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user within the Finestra Financials application, linked to an external authentication system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserProfile entity, typically provided by the external authentication system."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "name": {
          "type": "string",
          "description": "Display name of the user."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the user profile was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the user profile was last updated.",
          "format": "date-time"
        },
        "initialCashBalance": {
          "type": "number",
          "description": "The user's initial cash balance to start cashflow calculations."
        }
      },
      "required": [
        "id",
        "email",
        "name",
        "createdAt",
        "updatedAt"
      ]
    },
    "Project": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Project",
      "type": "object",
      "description": "Represents a financial project with its planned and actual costs/revenues.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Project entity (e.g., P-001)."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the UserProfile who owns or manages this project. (Relationship: UserProfile 1:N Project)"
        },
        "name": {
          "type": "string",
          "description": "Name of the project."
        },
        "client": {
          "type": "string",
          "description": "Name of the client for this project."
        },
        "startDate": {
          "type": "string",
          "description": "Data da venda.",
          "format": "date"
        },
        "status": {
          "type": "string",
          "description": "Current status of the project.",
          "enum": [
            "Pendente",
            "Em andamento",
            "Instalado",
            "Concluído",
            "Cancelado"
          ]
        },
        "plannedTotalRevenue": {
          "type": "number",
          "description": "Valor total (R$): Total estimated revenue for the project."
        },
        "plannedTotalCost": {
          "type": "number",
          "description": "Custo estimado (R$): Total estimated cost for the project."
        },
        "actualTotalRevenue": {
          "type": "number",
          "description": "Receita realizada (R$): Calculated total actual revenue received for the project, dynamically updated from associated RevenueItems."
        },
        "actualTotalCost": {
          "type": "number",
          "description": "Custos diretos realizados (R$): Calculated total actual cost incurred for the project, dynamically updated from associated CostItems."
        },
        "description": {
          "type": "string",
          "description": "A brief description or overview of the project."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the project was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the project was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "name",
        "client",
        "startDate",
        "status",
        "plannedTotalCost",
        "plannedTotalRevenue",
        "actualTotalCost",
        "actualTotalRevenue",
        "createdAt",
        "updatedAt"
      ]
    },
    "CostItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CostItem",
      "type": "object",
      "description": "Represents a single cost entry for a project, including planned versus actual amounts.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the CostItem entity."
        },
        "projectId": {
          "type": "string",
          "description": "Reference to the Project this cost item belongs to. (Relationship: Project 1:N CostItem)"
        },
        "userId": {
          "type": "string",
          "description": "Denormalized reference to the UserProfile who owns the project."
        },
        "name": {
          "type": "string",
          "description": "A descriptive name for the cost item (e.g., 'Salários - Janeiro', 'Material A')."
        },
        "supplier": {
          "type": "string",
          "description": "The supplier or vendor for this cost item. Optional."
        },
        "category": {
          "type": "string",
          "description": "Category of the cost (e.g., 'mão de obra', 'materiais', 'marketing')."
        },
        "plannedAmount": {
          "type": "number",
          "description": "The predicted amount for this cost item."
        },
        "actualAmount": {
          "type": "number",
          "description": "The actual amount spent for this cost item."
        },
        "status": {
          "type": "string",
          "description": "The payment status of the cost item.",
          "enum": [
            "Pendente",
            "Pago"
          ]
        },
        "transactionDate": {
          "type": "string",
          "description": "The date when the cost was incurred or paid.",
          "format": "date"
        },
        "description": {
          "type": "string",
          "description": "Detailed description of the cost."
        },
        "isInstallment": {
          "type": "boolean",
          "description": "Indicates if this cost item is part of a larger installment plan."
        },
        "installmentNumber": {
          "type": "number",
          "description": "The sequential number of this installment if 'isInstallment' is true."
        },
        "totalInstallments": {
          "type": "number",
          "description": "The total number of installments in the plan if 'isInstallment' is true."
        },
        "isRecurring": {
          "type": "boolean",
          "description": "Indicates if this is a recurring cost."
        },
        "frequency": {
          "type": "string",
          "description": "The frequency of the recurring cost.",
          "enum": ["monthly", "annually"]
        },
        "deviationAnalysisNote": {
          "type": "string",
          "description": "Notes or suggestions from the deviation analysis assistant regarding this cost."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the cost item was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the cost item was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "name",
        "category",
        "plannedAmount",
        "actualAmount",
        "transactionDate",
        "isInstallment",
        "createdAt",
        "updatedAt",
        "status"
      ]
    },
    "RevenueItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "RevenueItem",
      "type": "object",
      "description": "Represents a single revenue entry for a project, including planned versus received amounts.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the RevenueItem entity."
        },
        "projectId": {
          "type": "string",
          "description": "Reference to the Project this revenue item belongs to. (Relationship: Project 1:N RevenueItem)"
        },
        "userId": {
          "type": "string",
          "description": "Denormalized reference to the UserProfile who owns the project."
        },
        "paymentMethodId": {
          "type": "string",
          "description": "Reference to the PaymentMethod used for this revenue. (Relationship: PaymentMethod 1:N RevenueItem)"
        },
        "name": {
          "type": "string",
          "description": "A descriptive name for the revenue item (e.g., 'Pagamento Parcela 1 - Cliente X')."
        },
        "plannedAmount": {
          "type": "number",
          "description": "The predicted amount for this revenue item."
        },
        "receivedAmount": {
          "type": "number",
          "description": "The actual amount received for this revenue item."
        },
        "transactionDate": {
          "type": "string",
          "description": "The date when the revenue was received or expected.",
          "format": "date"
        },
        "description": {
          "type": "string",
          "description": "Detailed description of the revenue."
        },
        "isInstallment": {
          "type": "boolean",
          "description": "Indicates if this revenue item is part of a larger installment plan."
        },
        "installmentNumber": {
          "type": "number",
          "description": "The sequential number of this installment if 'isInstallment' is true (e.g., 1 for the first installment)."
        },
        "totalInstallments": {
          "type": "number",
          "description": "The total number of installments in the plan if 'isInstallment' is true."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the revenue item was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the revenue item was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "projectId",
        "userId",
        "paymentMethodId",
        "name",
        "plannedAmount",
        "receivedAmount",
        "transactionDate",
        "description",
        "isInstallment",
        "createdAt",
        "updatedAt"
      ]
    },
    "PaymentMethod": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "PaymentMethod",
      "type": "object",
      "description": "Represents a customizable payment method used for tracking revenues.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the PaymentMethod entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the UserProfile who created or owns this payment method. (Relationship: UserProfile 1:N PaymentMethod)"
        },
        "name": {
          "type": "string",
          "description": "User-friendly name of the payment method (e.g., 'Cartão de Crédito', 'Transferência Bancária')."
        },
        "type": {
          "type": "string",
          "description": "Categorization of the payment method (e.g., 'cash', 'credit_card', 'bank_transfer', 'pix')."
        },
        "description": {
          "type": "string",
          "description": "Further description or details about the payment method."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the payment method was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the payment method was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "name",
        "type",
        "createdAt",
        "updatedAt"
      ]
    },
    "CostCategory": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CostCategory",
      "type": "object",
      "description": "Represents a user-defined cost category for tracking expenses.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the CostCategory entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the UserProfile who owns this category."
        },
        "name": {
          "type": "string",
          "description": "The name of the cost category (e.g., 'Aluguel', 'Fornecedores')."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the category was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "name",
        "createdAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Root collection for user profiles, where each document ID matches the Firebase Authentication UID. This directly establishes primary ownership for all nested data.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, matching Firebase Authentication UID."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/projects/{projectId}",
        "definition": {
          "entityName": "Project",
          "schema": {
            "$ref": "#/backend/entities/Project"
          },
          "description": "Collection for individual financial projects, owned by a specific user. The 'userId' is denormalized in the path and the document for authorization independence and QAP support.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns this project."
            },
            {
              "name": "projectId",
              "description": "The unique identifier for the project."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/costItems/{costItemId}",
        "definition": {
          "entityName": "CostItem",
          "schema": {
            "$ref": "#/backend/entities/CostItem"
          },
          "description": "Collection for cost entries. Can be optionally linked to a project. The 'userId' is denormalized for authorization.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns this cost item."
            },
            {
              "name": "costItemId",
              "description": "The unique identifier for the cost item."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/projects/{projectId}/revenueItems/{revenueItemId}",
        "definition": {
          "entityName": "RevenueItem",
          "schema": {
            "$ref": "#/backend/entities/RevenueItem"
          },
          "description": "Subcollection for revenue entries related to a specific project. The 'userId' from the parent project is denormalized into each RevenueItem document for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns the parent project."
            },
            {
              "name": "projectId",
              "description": "The unique identifier of the parent project."
            },
            {
              "name": "revenueItemId",
              "description": "The unique identifier for the revenue item."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/paymentMethods/{paymentMethodId}",
        "definition": {
          "entityName": "PaymentMethod",
          "schema": {
            "$ref": "#/backend/entities/PaymentMethod"
          },
          "description": "Collection for user-specific payment methods. The 'userId' is denormalized in the path and the document for authorization independence and QAP support.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns this payment method."
            },
            {
              "name": "paymentMethodId",
              "description": "The unique identifier for the payment method."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/costCategories/{costCategoryId}",
        "definition": {
          "entityName": "CostCategory",
          "schema": {
            "$ref": "#/backend/entities/CostCategory"
          },
          "description": "Collection for user-defined cost categories. This allows users to customize how they classify their costs.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "costCategoryId",
              "description": "The unique identifier for the cost category."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure for Finestra Financials is designed with a strong emphasis on Authorization Independence, Structural Segregation, and clear Access Modeling to ensure robust security rules and efficient queries. The core strategy revolves around path-based ownership for all user-specific and project-specific data.\n\nAuthorization Independence is achieved primarily through a strict hierarchical path structure starting with the user's ID (`/users/{userId}/...`). Every document related to a user or their projects is nested under this `userId` path. Furthermore, critical authorization context, specifically the `userId` of the owner, is denormalized into every document that requires ownership checks (e.g., `Project`, `PaymentMethod`, `CostItem`, `RevenueItem`). While `Project` and `PaymentMethod` schemas already contain `userId`, `CostItem` and `RevenueItem` (which can be children of `Project`) will also explicitly store the `userId` of the project owner. This denormalization means that security rules never need to perform `get()` operations on parent documents to determine access rights, making rules atomic, faster, and less prone to transaction/batching issues.\n\nStructural Segregation ensures that all documents within a given collection share the same security posture. For example, all `Project` documents under a specific `userId` path are private to that user. There are no mixed public/private documents or different access levels within the same collection. This simplifies security rules significantly, as the access logic can be consistently applied at the collection level based on the path and denormalized fields.\n\nQuery as Permission (QAP) is inherently supported by this structure. Because all user-owned data is segmented by `userId` in the path (`/users/{userId}/...`), any `list` operation performed by an authenticated user (`request.auth.uid`) can only retrieve documents from their own designated path. For instance, a user can only query `/users/their_uid/projects` and not `/users/another_uid/projects`. This ensures that security rules act as effective filters, preventing unauthorized access even on `list` operations without relying on complex and inefficient database queries within the rules themselves. Similarly, `CostItem` and `RevenueItem` are nested under the specific `projectId` within the user's path, guaranteeing that `list` queries for these items are always scoped to the correct project and owner. This radical consistency in data ownership and access modeling simplifies both rule writing and application development."
  }
}
