rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // This rule allows a user to read any document in the database if the path
    // contains their user ID. This is the standard and secure way to enable
    // collection group queries while maintaining user data isolation.
    match /users/{userId}/{document=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }

    // --- Write Rules ---
    // Write rules are more granular to ensure data integrity and that users
    // can only modify their own data.

    // User can only write to their own user profile document.
    match /users/{userId} {
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Users can write to documents in their own subcollections,
    // with an additional check that the document data itself contains their userId.
    // This prevents accidental data misplacement.
    match /users/{userId}/projects/{projectId} {
      allow write: if request.auth != null && request.auth.uid == userId && request.resource.data.userId == userId;
    }

    match /users/{userId}/projects/{projectId}/costItems/{costItemId} {
      allow write: if request.auth != null && request.auth.uid == userId && request.resource.data.userId == userId;
    }
    
    match /users/{userId}/projects/{projectId}/revenueItems/{revenueItemId} {
      allow write: if request.auth != null && request.auth.uid == userId && request.resource.data.userId == userId;
    }

    match /users/{userId}/paymentMethods/{paymentMethodId} {
      allow write: if request.auth != null && request.auth.uid == userId && request.resource.data.userId == userId;
    }

    match /users/{userId}/fixedCosts/{fixedCostId} {
      allow write: if request.auth != null && request.auth.uid == userId && request.resource.data.userId == userId;
    }
  }
}
