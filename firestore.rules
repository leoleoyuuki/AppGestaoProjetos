rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Regra principal para acesso de leitura. Um usuário pode ler (get, list) qualquer documento
    // se o seu UID estiver no caminho. Isso protege as leituras de documentos individuais
    // e permite listar coleções como 'projects' e 'fixedCosts'.
    match /users/{userId}/{document=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }

    // Regra específica para consultas de grupo de coleções. Isso permite que a operação 'list'
    // seja iniciada. A regra 'read' acima (via 'get' implícito) garantirá a segurança 
    // dos documentos individuais retornados pela consulta.
    match /{path=**}/revenueItems/{revenueItem} {
      allow list: if request.auth != null;
    }
    match /{path=**}/costItems/{costItem} {
      allow list: if request.auth != null;
    }

    // --- Regras de Escrita ---
    // As regras de escrita são mais granulares para garantir a integridade dos dados e que os usuários
    // possam apenas modificar seus próprios dados.

    // O usuário só pode escrever em seu próprio documento de perfil de usuário.
    match /users/{userId} {
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Os usuários podem escrever em documentos em suas próprias subcoleções,
    // com uma verificação adicional de que os próprios dados do documento contêm seu userId.
    // Isso evita a colocação incorreta acidental de dados.
    match /users/{userId}/projects/{projectId} {
      allow write: if request.auth != null && request.auth.uid == userId && request.resource.data.userId == userId;
    }

    match /users/{userId}/projects/{projectId}/costItems/{costItemId} {
      allow write: if request.auth != null && request.auth.uid == userId && request.resource.data.userId == userId;
    }
    
    match /users/{userId}/projects/{projectId}/revenueItems/{revenueItemId} {
      allow write: if request.auth != null && request.auth.uid == userId && request.resource.data.userId == userId;
    }

    match /users/{userId}/paymentMethods/{paymentMethodId} {
      allow write: if request.auth != null && request.auth.uid == userId && request.resource.data.userId == userId;
    }

    match /users/{userId}/fixedCosts/{fixedCostId} {
      allow write: if request.auth != null && request.auth.uid == userId && request.resource.data.userId == userId;
    }
  }
}
